events {
    worker_connections 1024;
}

http {
    # Rate limiting: 2 requests/second per IP, burst of 5
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=2r/s;
    limit_req_status 503;

    upstream reservation_backend {
        server reservation-service:8000;
    }

    server {
        listen 80;

        location /api/ {
            # Apply rate limiting - "Diluvio de Peticiones"
            limit_req zone=api_limit burst=5 nodelay;

            proxy_pass http://reservation_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            
            proxy_connect_timeout 5s;
            proxy_read_timeout 30s;
        }

        error_page 503 = @rate_limited;
        location @rate_limited {
            default_type application/json;
            return 503 '{"error": "Demasiadas peticiones. Intente mas tarde.", "code": "RATE_LIMITED"}';
        }
    }
}
